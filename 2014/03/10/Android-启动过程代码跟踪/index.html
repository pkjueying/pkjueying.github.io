<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="hello, It's me......"><title>Android 启动过程代码跟踪 | Drogon龘</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android 启动过程代码跟踪</h1><a id="logo" href="/.">Drogon龘</a><p class="description">蒹葭苍苍,道阻且长......</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/book/"><i class="fa fa-book"> 书籍</i></a><a href="/heart/"><i class="fa fa-heart"> 可可</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android 启动过程代码跟踪</h1><div class="post-meta">Mar 10, 2014<span> | </span><span class="category"><a href="/categories/old-blog/">old blog</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2014/03/10/Android-启动过程代码跟踪/" href="/2014/03/10/Android-启动过程代码跟踪/#comments" class="ds-thread-count"></a><div class="post-content"><blockquote>
<p>准备工作：Android源码，UnderStand源码阅读工具</p>
</blockquote>
<p>我们知道Android系统在启动时首先会启动Linux系统，引导加载Linux Kernel并启动init进程。Init进程是一个由内核启动的用户级进程，是Android系统的第一个进程。该进程的相关代码在android/system/core/init/init.c。在main函数中，有如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">init_parse_config_file(<span class="string">"/init.rc"</span>);</span><br><span class="line"></span><br><span class="line"> action_for_each_trigger(<span class="string">"early-init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line"> ......</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* execute all the boot actions to get us started */</span></span><br><span class="line"> action_for_each_trigger(<span class="string">"init"</span>, action_add_queue_tail);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* skip mounting filesystems in charger mode */</span></span><br><span class="line"> <span class="keyword">if</span> (!is_charger) &#123;</span><br><span class="line">     action_for_each_trigger(<span class="string">"early-fs"</span>, action_add_queue_tail);</span><br><span class="line">     action_for_each_trigger(<span class="string">"fs"</span>, action_add_queue_tail);</span><br><span class="line">     action_for_each_trigger(<span class="string">"post-fs"</span>, action_add_queue_tail);</span><br><span class="line">     action_for_each_trigger(<span class="string">"post-fs-data"</span>, action_add_queue_tail);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> .......</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (is_charger) &#123;</span><br><span class="line">     action_for_each_trigger(<span class="string">"charger"</span>, action_add_queue_tail);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     action_for_each_trigger(<span class="string">"early-boot"</span>, action_add_queue_tail);</span><br><span class="line">     action_for_each_trigger(<span class="string">"boot"</span>, action_add_queue_tail);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里会加载init.rc并进行解析，init.rc文件定义了在init进程中需要启动哪些进程服务和执行哪些动作。其详细说明参见android/system/core/init/reademe.txt。init.rc见如下定义：</p>
<p>……<br>service servicemanager /system/bin/servicemanager<br>    class core<br>    user system<br>    group system<br>    critical<br>    onrestart restart zygote<br>    onrestart restart media<br>    onrestart restart surfaceflinger<br>    onrestart restart drm</p>
<p>service vold /system/bin/vold<br>    class core<br>    socket vold stream 0660 root mount<br>    ioprio be 2</p>
<p>……..</p>
<p>service zygote /system/bin/app_process -Xzygote /system/bin –zygote –start-system-server<br>    class main<br>    socket zygote stream 660 root system<br>    onrestart write /sys/android_power/request_state wake<br>    onrestart write /sys/power/state on<br>    onrestart restart media<br>    onrestart restart netd</p>
<p>service drm /system/bin/drmserver<br>    class main<br>    user drm<br>    group drm system inet drmrpc sdcard_r</p>
<p>service media /system/bin/mediaserver<br>    class main</p>
<p>……….</p>
<p>具体解析过程见android/system/core/init/Init_parser.c。解析所得服务添加到service_list中，动作添加到action_list中。主要代码流程如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (next_token(&amp;state)) &#123;</span><br><span class="line">        <span class="keyword">case</span> T_EOF:</span><br><span class="line">            state.parse_line(&amp;state, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">goto</span> parser_done;</span><br><span class="line">        <span class="keyword">case</span> T_NEWLINE:</span><br><span class="line">            state.line++;</span><br><span class="line">            <span class="keyword">if</span> (nargs) &#123;</span><br><span class="line">                <span class="keyword">int</span> kw = lookup_keyword(args[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">if</span> (kw_is(kw, SECTION)) &#123;</span><br><span class="line">                    state.parse_line(&amp;state, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    parse_new_section(&amp;state, kw, nargs, args);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    state.parse_line(&amp;state, nargs, args);</span><br><span class="line">                &#125;</span><br><span class="line">                nargs = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> T_TEXT:</span><br><span class="line">            <span class="keyword">if</span> (nargs &lt; INIT_PARSER_MAXARGS) &#123;</span><br><span class="line">                args[nargs++] = state.text;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">parser_done:</span><br><span class="line">    list_for_each(node, &amp;import_list) &#123;</span><br><span class="line">         <span class="keyword">struct</span> import *import = node_to_item(node, struct import, list);</span><br><span class="line">         <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">         INFO(<span class="string">"importing '%s'"</span>, import-&gt;filename);</span><br><span class="line">         ret = init_parse_config_file(import-&gt;filename);</span><br><span class="line">         <span class="keyword">if</span> (ret)</span><br><span class="line">             ERROR(<span class="string">"could not import file '%s' from '%s'\n"</span>,</span><br><span class="line">                   import-&gt;filename, fn);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来在main函数中执行动作和启动进程服务：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span>(; ;) &#123;</span><br><span class="line">......</span><br><span class="line">execute_one_command();</span><br><span class="line">        restart_processes();</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通常init过程需要创建一些系统文件夹并启动USB守护进程、Android Debug Bridge守护进程、Debug守护进程、ServiceManager进程、Zygote进程等。</p>
<p>由init.rc对ServiceManager的描述service servicemanager /system/bin/servicemanager可知servicemanager进程从platform\frameworks\base\cmd\servicemanager\Service_manager.cpp启动。在main函数中有如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> binder_state *bs;</span><br><span class="line">    <span class="keyword">void</span> *svcmgr = BINDER_SERVICE_MANAGER;</span><br><span class="line"></span><br><span class="line">    bs = binder_open(<span class="number">128</span>*<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (binder_become_context_manager(bs)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"cannot become context manager (%s)\n"</span>, strerror(errno));</span><br><span class="line">        return <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    svcmgr_handle = svcmgr;</span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在android/framework/base/cmd/servicemanager/Binder.c中<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_become_context_manager</span><span class="params">(<span class="keyword">struct</span> binder_state *bs)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    return ioctl(bs-&gt;fd, BINDER_SET_CONTEXT_MGR, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上首先调用binder_open()打开Binder设备(/dev/binder)，调用binder_become_context_manager()把当前进程设置为ServiceManager。ServiceManager本身就是一个服务。最后binder_loop()进入循环状态，并设置svcmgr_handler回调函数等待添加、查询、获取服务等请求。</p>
<p>在启动servicemanager的同时，再来启动Zygote，由init.rc对zygote的描述service zygot /system/bin/app_process可知zygote进程从Android\frameworks\base\cmds\app_process\App_main.cpp启动。这个文件的main（）方法，会调用Android_Runtime.cpp的文件中的start（）方法，这个方法通过JNI机制，来调用ZygoteInit.java孵化器初始文件，这个文件的Main（）函数，将会去调用所有进程。其主要代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (!parentDir) &#123;</span><br><span class="line">            parentDir = arg;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = <span class="string">"zygote"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName = arg + <span class="number">12</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            className = arg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">........</span><br><span class="line"><span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>,</span><br><span class="line">                startSystemServer ? <span class="string">"start-system-server"</span> : <span class="string">""</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        <span class="comment">// Remainder of args get passed to startup class main()</span></span><br><span class="line">        runtime.mClassName = className;</span><br><span class="line">        runtime.mArgC = argc - i;</span><br><span class="line">        runtime.mArgV = argv + i;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>,</span><br><span class="line">                application ? <span class="string">"application"</span> : <span class="string">"tool"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        return <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中runtime是AppRuntime类型，而AppRuntime继承至AndroidRuntime。我们继续跟踪 runtime.start函数：因在AppRuntime中没有对start的复写，我们到AppRuntime查看start的实现，路劲：android/framework/base/core/init<br>代码如下：注意runtime.start所传的参数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> <span class="keyword">char</span>* options)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(options, <span class="string">"start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* start the virtual machine */</span></span><br><span class="line"> JNIEnv* env;</span><br><span class="line"> <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env) != <span class="number">0</span>) &#123;</span><br><span class="line">return;</span><br><span class="line"> &#125;</span><br><span class="line"> onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * Start VM.  This thread becomes the main thread of the VM, and will</span><br><span class="line">     * not return until the VM exits.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);     <span class="comment">//com.android.internal.os.ZygoteInit</span></span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line">	    ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即先启动了虚拟机，然后利用JNI调用了zygoteInit。路劲：android/framework/base/core/java/com/android/internal/os在ZygoteInit的main中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (argv[<span class="number">1</span>].equals(<span class="string">"start-system-server"</span>)) &#123;</span><br><span class="line">                startSystemServer();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!argv[<span class="number">1</span>].equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                throw new RuntimeException(argv[<span class="number">0</span>] + USAGE_STRING);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续跟踪startSystemServer() ， 在startSystemServer()中 ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private static boolean startSystemServer() throws </span><br><span class="line">	MethodAndArgsCaller, RuntimeException &#123;</span><br><span class="line">        String args[] = &#123;</span><br><span class="line">            ...</span><br><span class="line">            "--runtime-init",</span><br><span class="line">            "--nice-name=system_server",</span><br><span class="line">            "com.android.server.SystemServer",</span><br><span class="line">        &#125;;</span><br><span class="line">       </span><br><span class="line">        try &#123;</span><br><span class="line">            parsedArgs = new ZygoteConnection.Arguments(args);</span><br><span class="line">            ...</span><br><span class="line">            pid = Zygote.forkSystemServer(</span><br><span class="line">                    ...</span><br><span class="line">                    parsedArgs.permittedCapabilities,</span><br><span class="line">                    parsedArgs.effectiveCapabilities);</span><br><span class="line">        &#125; catch (IllegalArgumentException ex) &#123;</span><br><span class="line">            throw new RuntimeException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p> Zygote包装了Linux的fork。forkSystemServer()调用forkAndSpecialize()，最终穿过虚拟机调用android\dalvik\vm\native\dalvik_system_Zygote.c中Dalvik_dalvik_system_Zygote_forkAndSpecialize()。由dalvik完成fork新的进程。<br> main()最后会调用runSelectLoopMode()，进入while循环，由peers创建新的进程。</p>
<p>我们跳转至com.android.server.SystemServer中,目录：android/framework/base/services/java/com/android/server </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    	...</span><br><span class="line">        init1(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在其main()函数中调用了init1(args)这个native函数，利用JNI机制，跟踪至frameworks/base/services/jni/com_android_server_systemService.cpp，然后到<br>frameworks/base/cmds/system_server/library/system_init.cpp在system_init()函数中有如下代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">"1"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Start the SurfaceFlinger</span></span><br><span class="line">    SurfaceFlinger::instantiate();</span><br><span class="line">&#125;</span><br><span class="line">AndroidRuntime* runtime = AndroidRuntime::getRuntime();</span><br><span class="line">...</span><br><span class="line">LOGI(<span class="string">"System server: starting Android services./n"</span>);</span><br><span class="line">runtime-&gt;callStatic(<span class="string">"com/android/server/SystemServer"</span>, <span class="string">"init2"</span>);</span><br></pre></td></tr></table></figure></p>
<p>  即完成了SurfaceFlinger的实例化，然后利用运行时的callStatic()函数调用了SystemServer的init2()函数.代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> final <span class="keyword">void</span> <span class="title">init2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Slog.i(TAG, <span class="string">"Entered the Android system server!"</span>);</span><br><span class="line">       Thread thr = new ServerThread();</span><br><span class="line">       thr.setName(<span class="string">"android.server.ServerThread"</span>);</span><br><span class="line">       thr.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个ServerThread线程中，就可以看到我们熟悉的Android服务了：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@<span class="function">Override</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN,</span><br><span class="line">        SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    ContentService contentService = null;</span><br><span class="line">    LightsService lights = null;</span><br><span class="line">    PowerManagerService power = null;</span><br><span class="line">    DynamicPManagerService dpm = null;</span><br><span class="line">    DisplayManagerService display = null;</span><br><span class="line">    BatteryService battery = null;</span><br><span class="line">    VibratorService vibrator = null;</span><br><span class="line">    AlarmManagerService alarm = null;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">           </span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">   	<span class="keyword">try</span> &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Status Bar"</span>);</span><br><span class="line">            statusBar = new StatusBarManagerService(context, wm);</span><br><span class="line">            ServiceManager.addService(Context.STATUS_BAR_SERVICE, statusBar);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">"starting StatusBarManagerService"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Clipboard Service"</span>);</span><br><span class="line">            ServiceManager.addService(Context.CLIPBOARD_SERVICE,</span><br><span class="line">                    new ClipboardService(context));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">"starting Clipboard Service"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"NetworkManagement Service"</span>);</span><br><span class="line">            networkManagement = NetworkManagementService.create(context);</span><br><span class="line">            ServiceManager.addService(Context.NETWORKMANAGEMENT_SERVICE, networkManagement);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">"starting NetworkManagement Service"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    Looper.loop();</span><br><span class="line">    Slog.d(TAG, <span class="string">"System ServerThread is exiting!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后，调用各服务的systemReady()函数通知系统就绪,至此，系统的启动过程结束.</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://github.com/pkjueying/pkjueying.github.io/2014/03/10/Android-启动过程代码跟踪/" data-id="ciod19ej3000184vro57u7gp2" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2014/04/11/Android-开机动画跟踪/" class="pre"> android4.2 开机动画跟踪</a><a href="/2013/12/29/XW-Android-02/" class="next">XW-Android-02</a></div><div data-thread-key="2014/03/10/Android-启动过程代码跟踪/" data-title="Android 启动过程代码跟踪" data-url="https://github.com/pkjueying/pkjueying.github.io/2014/03/10/Android-启动过程代码跟踪/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://github.com/pkjueying/pkjueying.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/history/">history</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/old-blog/">old blog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/work/" style="font-size: 15px;">work</a> <a href="/tags/Yii/" style="font-size: 15px;">Yii</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/heart/" style="font-size: 15px;">heart</a> <a href="/tags/binder/" style="font-size: 15px;">binder</a> <a href="/tags/book/" style="font-size: 15px;">book</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/05/18/罗马人的故事01/">罗马人的故事01</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/17/thingking-everyday/">每天随记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/13/don-t-lazy/">don't lazy</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/17/binder01/">binder简要学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/04/11/Android-开机动画跟踪/"> android4.2 开机动画跟踪</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/03/10/Android-启动过程代码跟踪/">Android 启动过程代码跟踪</a></li><li class="post-list-item"><a class="post-list-link" href="/2013/12/29/XW-Android-02/">XW-Android-02</a></li><li class="post-list-item"><a class="post-list-link" href="/2013/12/18/XW-Android-01/">XW-Android-01</a></li><li class="post-list-item"><a class="post-list-link" href="/2012/11/18/Yii项目实践/">yii项目实践</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://share2your.info" title="tjl可可" target="_blank">tjl可可</a><ul></ul><a href="http://blog.csdn.net/v_JULY_v?viewmode=contents" title="v_JULY_v数据结构＋算法" target="_blank">v_JULY_v数据结构＋算法</a><ul></ul><a href="http://blog.csdn.net/Luoshengyang?viewmode=contents" title="老罗的android" target="_blank">老罗的android</a><ul></ul><a href="http://cooshell.cn/" title="coolShell" target="_blank">coolShell</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Drogon龘.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'zfltjl080519'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>